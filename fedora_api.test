<?php
/*
 * $Id: $
 */

/*
 * $file
 *
 * Run through tests of the Fedora API funcitons.
 */
class FedoraAPITestCase extends DrupalWebTestCase {
  private $pidslist = array();
  protected $privileged_user;
  
  public static function getInfo() {
    return array(
      'name' => 'Fedora api',
      'description' => t('The fedora repository API tests'),
      'group' => t('fedora repository'),
    );
  }

  function setUp() {
    parent::setUp('fedora_api');  

    // Create and login user.
    $this->privileged_user = $this->drupalCreateFedoraUser();
    $this->pass("Password: ".$this->privileged_user->pass);

    $this->drupalLogin($this->privileged_user);
    module_load_include('inc', 'fedora_api', 'fedora_api.raw');
    global $base_url;
    variable_set('fedora_user', 'fedoraAdmin');
    variable_set('fedora_password', 'fedoraAdmin');
  }

  public function testAPIA() {
    global $base_url;
    $api = new FedoraAPI();
    
    
    $profile = $api->getObjectProfile('islandora:demos');
    
    if (empty($profile->error)) {
      $this->pass('Fedora API-A getObjectProfile passed.');
    }
    $dslist = $api->listDatastreams('islandora:demos');
    if (empty($dslist->error)) {
      $this->pass('Fedora API-A listDatastreams passed.');
    }
    $methodlist = $api->listMethods('islandora:demos');
    if (empty($methodlist->error)) {
      $this->pass('Fedora API-A listMethods passed.');
    }

    $find_results = $api->findObjects("*islandora*", "" );
    if (empty($find_results->error)) {
      $this->pass('Fedora API-A findObjects passed.');
    }
    $dc_stream = $api->getDatastreamDissemination("fedora-system:FedoraObject-3.0", "DC", '', 'false');
    if (empty($dc_stream->error)) {
      if (strpos($dc_stream->data, '<oai_dc:dc') >= 0) {
        $this->pass('Fedora API-A getDatastreamDissemination passed.');
      }
      else {
        $this->fail("Failed to retrieve DC datastream for fedora-system:FedoraObject-3.0. Instead got: ".$dc_stream);
      }
    }
    else {
      $this->fail("Error calling drupal_http_request. ".$dc_stream->error);
    }

    $dc_html = $api->getDissemination('fedora-system:FedoraObject-3.0', 'fedora-system:3', 'viewDublinCore');
    if (empty($dc_html->error)) {
      if (strpos($dc_html->data, 'Dublin Core View') >= 0) {
        $this->pass('Fedora API-A getDissemination passed.');
      }
      else {
        $this->fail("Failed to retrieve viewDublinCore Disseminator for fedora-system:FedoraObject-3.0. Instead got: ".$dc_html);
      }
    }
    else {
      $this->fail("Error calling drupal_http_request for getDissemination: $dc_html->error");
    }

    $obj_hist = $api->getObjectHistory('fedora-system:FedoraObject-3.0');
    if (empty($obj_hist->error)) {
      if (strpos($obj_hist->data, 'fedoraObjectHistory') >= 0) {
        $this->pass('Fedora API-A getObjectHistory passed.');
      }
      else {
        $this->fail("Failed to retrieve object history for fedora-system:FedoraObject-3.0. Instead got: ".$obj_hist);
      }
    }
    else {
      $this->fail("Error calling drupal_http_request for getObjectHistory: $obj_hist->error");
    }

    $testDSID = $this->randomName(11);

    $data = $api->addDatastream('fedora-system:FedoraObject-3.0', $testDSID, 'M', '', '', $base_url.'/themes/garland/logo.png', '', 'hipig', 'A', '', '', '', 'image/png');

    if ($data->code == 201) {
      $this->pass('Add managed datastream test successful: '.$data->error);
    }
    else {
      $this->fail('Problem running testaddDatastream: '.$data->error);
    }

    $test_file_DSID = $this->randomName(11);
    $file_add_data = $api->addDatastream('fedora-system:FedoraObject-3.0', $test_file_DSID, 'M', getcwd().'/themes/garland/logo.png', '', '', '', 'hipig', 'A', '', '', '', 'image/png');

    if ($file_add_data->code == 201) {
      $this->pass('Add managed datastream from file test successful: '.$file_add_data->error);
    }
    else {
      $this->fail('Problem running testaddDatastream for file: '.$file_add_data->error);
    }

    $test_export = $api->export('fedora-system:FedoraObject-3.0');
    if (empty($test_export->error)) {
      if (strpos($test_export->data, 'foxml:digitalObject') >= 0) {
        $this->pass("Successfully exported FOXML.");
      }
      else {
        $this->fail('Problem running export command, got: '.$test_export->data);
      }
    }
    else {
      $this->fail('Problem executing drupal_http_request for fedora_export: '.$test_export->error);
    }

    $test_nextPID = $api->getNextPID();
    if (empty($test_nextPID->error)) {
      if (strpos($test_nextPID->data, 'pidlist') >= 0) {
        $this->pass('Successfully called getNextPID.');
      }
      else {
        $this->fail('Problem calling getNextPID: '.$test_nextPID->data);
      }
    }
    else {
      $this->fail('Problem executing drupal_http_request for getNextPID: '.$test_nextPID->error);
    }

    $test_objectXML = $api->getObjectXML('fedora-system:FedoraObject-3.0');
    if (empty($test_objectXML->error)) {
      if (strpos($test_objectXML->data, 'foxml:digitalObject') >= 0) {
        $this->pass('Successfully called getObjectXML.');
      }
      else {
        $this->fail('Problem calling getObjectXML. Got: '.$test_objectXML->data);
      }
    }
    else {
      $this->fail('Problem calling drupal_http_request: '.$test_objectXML->error);
    }
  }

  public function testAPIM() {
    // Create a new object with no pid or any other parameters specified.
    // Should return with the PID, and only contain the default 'DC' datastream.
    $api = new FedoraAPI();
    
    $resp_blank_pid = $api->ingest();
    
    if ($resp_blank_pid->code == 201) {
      $this->pass("Object with new PID $resp_blank_pid->data created successfully.", 'API-M');
      $this->pidslist[] = $resp_blank_pid->data;
    }
    else {
      $this->fail("Attempt to create object with blank pid. $resp_blank_pid->error");
    }
    
    // Test create an object with a given pid namespace.
    $namespace = $this->randomName(6);
    $resp_namespace = $api->ingest(NULL, NULL, NULL, NULL, NULL, NULL, NULL, $namespace);
    if ($resp_namespace->code == 201) {
      $this->pass("Object with blank pid, namespace $namespace, new PID $resp_namespace->data created successfully.", 'API-M');
      $this->pidslist[] = $resp_namespace->data;
    }
    else {
      $this->fail("Attempt to create object with blank pid, namespace $namespace. $resp_namespace->error");
    }
    
    // Test ingest from an XML file. First do a sanity test to make sure the pid for the object doesn't already exist.
    $foxml_pid = 'gpWr4f:1';
    $resp_foxml = $api->ingest(drupal_get_path('module', 'fedora_api').'/test_data/test_ingest_foxml.xml');
    if ($resp_foxml->code == 201) {
      $this->pass('Ingest object from existing FOXML file.');
      $this->pidslist[] = $resp_foxml->data;
    }
    else {
      $this->fail("Ingest object from existing FOXML file. $resp_foxml->error");
    }
    
    // Test ingest from an FOXML string.
    $foxml_string_pid = 'lsjdFijj:2333';
    $foxml_string_data = file_get_contents(drupal_get_path('module', 'fedora_api').'/test_data/test_ingest_foxml_2.xml');
    $resp_foxml_string = $api->ingest(NULL, $foxml_string_data);
    if ($resp_foxml_string->code == 201) {
      $this->pass('Ingest object from FOXML string');
      $this->pidslist[] = $resp_foxml_string->data;
    }
    else {
      $this->fail("Ingest object from FOXML string. $resp_foxml_string->error");
    }
    
  }
  
  public function testFedoraClient() {
    // Test ingest
    global $base_url;
    $client = new FedoraClient();
    
    try {
      $blank_pid = $client->ingest();
      $this->pass("Ingest blank object $blank_pid", 'FedoraClient');
      $this->pidslist[] = $blank_pid;
    } catch (HttpException $e) {
      $this->fail("Ingest blank object ".$e->getMessage(), 'FedoraClient');
    }
    // Attempt to ingest new object with existing pid, should raise an exception.
    if (!empty($blank_pid)) {
      try {
        $double_pid = $client->ingest(NULL, NULL, array('pid' => $blank_pid));
        $this->fail('Ingest with existing PID raises FedoraRest Exception', 'FedoraClient');
      }
      catch (FedoraRestException $e) {
        $this->pass('Ingest with existing PID raises FedoraRest Exception: '. $e->getMessage(), 'FedoraClient');
      }
    }
    
    // Test findObjects for a term.
    try {
      $resultset = $client->findObjects('*');
      $this->pass("findObjects with term \"*\" found ".count($resultset)." objects", 'FedoraClient');
    }
    catch (FedoraRestException $e) {
      $this->fail("findObjects with term \"*\": " . $e->getMessage(), 'FedoraClient');
    }
    
    // Test findObjects for a single, specific object.
    if (!empty($blank_pid)) {
      try {
        $resultset_query = $client->findObjects(NULL, "pid=$blank_pid");
        $this->pass("Find object with pid $blank_pid.", 'FedoraClient');
      }
      catch (FedoraRestException $e) {
        $this->fail("Find object with pid $blank_pid. " . $e->getMessage(), 'FedoraClient');
      }
    }
  }
  
  
  public function testFedoraItem() {
    global $base_url;
    
    $client = new FedoraClient();
    $pid = $client->ingest();
    $this->pidslist[] = $pid;
    $item = new FedoraItem($pid);
    $this->assertEqual($pid, $item->pid, "Instantiate FedoraItem Object $pid", 'FedoraItem');
    $new_label = "The answer is: Moops.";
    $item->label = $new_label;
    $this->assertEqual($item->label, $new_label, "Test set label property.", 'FedoraItem');
    // Assert against the output of the raw API call to make sure the label really changed.
    $profile = $client->api->getObjectProfile($pid);
    if ($profile->code == 200) {
      $profile_doc = new SimpleXMLElement($profile->data);
      $this->assertEqual($item->label, (string) $profile_doc->objLabel, 'Test label property against the raw API call.', 'FedoraItem');
    }

    // Do a similar test for modifying ownerId.
    $new_ownerId = "FredTheTester";
    $item->ownerId = $new_ownerId;
    $this->assertEqual($item->ownerId, $new_ownerId, "Test set ownerId property.", 'FedoraItem');
    
    // Assert against the output of the raw API call to make sure the ownerId really changed.
    $profile = $client->api->getObjectProfile($pid);
    if ($profile->code == 200) {
      $profile_doc = new SimpleXMLElement($profile->data);
      $this->assertEqual($item->ownerId, (string) $profile_doc->objOwnerId, 'Test ownerId property against the raw API call.', 'FedoraItem');
    }
    
    // Test deleting an item.
    try {
      $item->delete();
      // Assert that find returns nothing.
      $this->assert(count($client->findObjects(NULL, "pid=$item->pid state=A")) == 0, "Deleting an object removes it from search results.", 'FedoraItem');
    }
    catch (FedoraRestException $e) {
      $this->fail("Delete item $item->pid. " . $e->getMessage());
    }
  }

  protected function drupalCreateFedoraUser($permissions = array('access comments', 'access content', 'post comments')) {
    // Create a role with the given permission set.
    if (!($rid = $this->drupalCreateRole($permissions))) {
     return FALSE;
    }

    // Create a user assigned to that role.
    $edit = array();
    $edit['name']   = 'simpletestuser';
    $edit['mail']   = $edit['name'] . '@example.com';
    $edit['roles']  = array($rid => $rid);
    $edit['pass']   = 'simpletestpass';
    $edit['status'] = 1;

    $account = user_save('', $edit);

    $this->assertTrue(!empty($account->uid), t('User created with name %name and pass %pass', array('%name' => $edit['name'], '%pass' => $edit['pass'])), t('User login'));
    if (empty($account->uid)) {
     return FALSE;
    }

    // Add the raw password so that we can log in as this user.
    $account->pass_raw = $edit['pass'];
    return $account;
  }
  
  protected function tearDown() {
    $api = new FedoraAPI();
    foreach ($this->pidslist as $pid) {
      $api->purgeObject($pid, "Drupal SimpleTest cleanup");
    }
    parent::tearDown();
    
  }
}